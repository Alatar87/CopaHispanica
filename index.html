<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Copa Hisp√°nica ¬∑ Temporada 60</title>
  <meta name="description" content="Copa Hisp√°nica (Temporada 60): 16 equipos, 2 grupos, 14 jornadas ida/vuelta, descanso y finales.">
  <style>
    :root{ --bg:#0b1220; --card:#0f172a; --muted:#94a3b8; --text:#e5e7eb; --accent:#60a5fa; --accent2:#a78bfa; --ok:#34d399; --warn:#f59e0b; --bad:#fb7185;}
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:linear-gradient(180deg,var(--bg),#0a0f1a 60%,#070b13);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif}
    a{color:var(--accent)}
    .container{max-width:1150px;margin:0 auto;padding:24px}
    header{position:sticky;top:0;z-index:10;backdrop-filter:saturate(170%) blur(8px);background:rgba(10,15,26,.82);border-bottom:1px solid rgba(255,255,255,.06)}
    .nav{display:flex;gap:16px;align-items:center;justify-content:space-between;padding:12px 24px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:40px;height:40px;border-radius:10px;background:radial-gradient(circle at 30% 30%, var(--accent), var(--accent2));box-shadow:0 0 32px rgba(96,165,250,.4)}
    .brand h1{font-size:1.08rem;margin:0;letter-spacing:.4px}
    .menu{display:flex;gap:12px;flex-wrap:wrap}
    .menu a{padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.06);text-decoration:none;color:var(--text);border:1px solid rgba(255,255,255,.08)}
    .menu a:hover{background:rgba(255,255,255,.1)}
    .hero{padding:60px 24px 24px}
    .hero .wrap{display:grid;grid-template-columns:1.15fr .85fr;gap:24px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.32);padding:20px}
    .title{font-size:clamp(28px,3vw,42px);margin:0 0 6px}
    .subtitle{margin:0;color:var(--muted)}
    .pill{display:inline-block;margin-top:12px;padding:6px 10px;border-radius:999px;background:rgba(96,165,250,.15);border:1px solid rgba(96,165,250,.35);color:#cfe4ff;font-size:.9rem}
    .grid{display:grid;gap:16px}
    .grid.cols-2{grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    .grid.cols-3{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    h2{margin:0 0 10px;font-size:1.25rem}
    h3{margin:0 0 8px;font-size:1.05rem}
    .muted{color:var(--muted)}
    .kpi{display:flex;gap:14px;align-items:center}
    .kpi .num{font-weight:800;font-size:1.4rem}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.07);text-align:left;vertical-align:top}
    th{color:#cfe4ff;font-weight:650;background:rgba(255,255,255,.04)}
    tr:hover td{background:rgba(255,255,255,.02)}
    .badge{padding:3px 8px;border-radius:999px;font-size:.8rem;border:1px solid rgba(255,255,255,.2);display:inline-block}
    .badge.ok{background:rgba(52,211,153,.1);border-color:rgba(52,211,153,.35)}
    .badge.warn{background:rgba(245,158,11,.1);border-color:rgba(245,158,11,.35)}
    .badge.bad{background:rgba(251,113,133,.1);border-color:rgba(251,113,133,.35)}
    .section{padding:24px}
    .two-col{display:grid;grid-template-columns:2fr 1fr;gap:24px}
    .note{background:rgba(96,165,250,.08);border:1px dashed rgba(96,165,250,.35);padding:12px;border-radius:12px}
    .small{font-size:.92rem}
    .footer{padding:24px;color:var(--muted);text-align:center}
    @media (max-width: 920px){ .hero .wrap{grid-template-columns:1fr} .two-col{grid-template-columns:1fr} }
    img.logo-br{display:block; max-height:44px; object-fit:contain}
    .groupTitle{display:flex;gap:8px;align-items:center}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
    .dot.azul{background:#38bdf8}
    .dot.rojo{background:#fb7185}
  </style>
</head>
<body>
  <header>
    <nav class="nav container">
      <div class="brand"><div class="logo" aria-hidden="true"></div><h1>Copa Hisp√°nica ¬∑ T60</h1></div>
      <div class="menu">
        <a href="#info">Informaci√≥n</a>
        <a href="#grupos">Grupos</a>
        <a href="#calendario">Calendario</a>
        <a href="#clasificacion">Clasificaci√≥n</a>
        <a href="#reglamento">Reglamento</a>
        <a href="#br-terms">BR ¬∑ T√©rminos</a>
        <a href="#contacto">Contacto</a>
      </div>
    </nav>
  </header>

  <main>
    <section class="hero">
      <div class="container wrap">
        <div class="card">
          <p class="pill">Copa Hisp√°nica ¬∑ Temporada 60 ¬∑ Lunes</p>
          <h2 class="title">Copa Hisp√°nica</h2>
          <p class="subtitle">16 equipos ¬∑ 2 grupos ¬∑ 14 jornadas (ida/vuelta) ¬∑ Jornada 15 descanso ¬∑ Jornada 16 finales y puestos.</p>
          <div class="grid cols-3" style="margin-top:16px">
            <div class="kpi card"><div><div class="num" id="kpiEquipos">16</div><div class="muted">Equipos</div></div></div>
            <div class="kpi card"><div><div class="num">14</div><div class="muted">Jornadas de grupos</div></div></div>
            <div class="kpi card"><div><div class="num">üèÜ</div><div class="muted">Trofeos cl√°sicos + Cuchara</div></div></div>
          </div>
          <div class="note" style="margin-top:12px">
            <strong>Inscripciones cerradas.</strong> Grupos creados seg√∫n ranking nacional. Partidos los <strong>lunes</strong> (amistoso).
          </div>
          <div style="margin-top:12px" class="small">
            Enlace requerido a BR: <a href="https://www.blackoutrugby.com/home.php" target="_blank" rel="noopener">https://www.blackoutrugby.com/home.php</a>
          </div>
        </div>

        <div class="card">
          <h2>Pr√≥ximo partido</h2>
          <div id="proximo" class="muted">A√∫n no definido</div>
          <hr style="border-color:rgba(255,255,255,.06);margin:16px 0">
          <h2>√öltimos resultados</h2>
          <ul id="ultimos" class="muted" style="padding-left:18px;margin:0"></ul>

          <div class="note small" style="margin-top:16px">
            <label><input type="checkbox" id="adminToggle"> Modo admin (local)</label>
            <div id="adminPanel" style="display:none; margin-top:8px">
              <div style="display:flex;gap:10px;flex-wrap:wrap">
                <button id="btnExport">Descargar results.json</button>
                <button id="btnLoadRepo">Cargar results.json del repo</button>
              </div>
              <p class="small muted" style="margin:8px 0 4px">Pega JSON v√°lido para importar/editar:</p>
              <textarea id="jsonArea" rows="9" style="width:100%" placeholder='[{"jornada":1,"fase":"Grupos (Ida)","grupo":"AZUL","fecha":"YYYY-MM-DD 19:35","local":"...","visitante":"...","pL":0,"pV":0,"tL":0,"tV":0,"estado":"finalizado"}]'></textarea>
              <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
                <button id="btnImport">Importar JSON</button>
                <button id="btnGuardarLocal">Guardar en este navegador</button>
                <button id="btnReset">Reset (plantilla)</button>
              </div>
              <p class="small muted">Sube el fichero descargado como <code>results.json</code> en la ra√≠z del repo.</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="info" class="section">
      <div class="container two-col">
        <div class="card">
          <h2>Resumen del hilo del foro</h2>
          <p>Recuperamos la Copa Hisp√°nica. Se juega los <strong>lunes</strong> y se reparten trofeos a los primeros clasificados y al √∫ltimo (Cuchara de Madera). Para la <strong>Temporada 60</strong> participan <strong>16 equipos</strong> y se han creado <strong>2 grupos</strong> seg√∫n ranking nacional.</p>
          <p>Formato: <strong>14 jornadas</strong> (ida y vuelta dentro de cada grupo). <strong>Jornada 15</strong> descanso. <strong>Jornada 16</strong> finales y cruces por puestos para cerrar la clasificaci√≥n final.</p>
        </div>
        <div class="card">
          <h2>Logos y cumplimiento</h2>
          <div class="note">
            <p class="small" style="margin:0 0 8px">BR exige usar el logo <strong>‚ÄúSanctioned Tournament‚Äù</strong> en todas las p√°ginas y enlazar a la home de BR.</p>
            <img class="logo-br" src="sanctioned-logo.png" alt="Blackout Rugby ¬∑ Sanctioned Tournament (a√±adir asset oficial)">
            <div class="small" style="margin-top:8px">Cuando tengas el logo oficial, s√∫belo como <code>sanctioned-logo.png</code> (sin editar).</div>
          </div>
        </div>
      </div>
    </section>

    <section id="grupos" class="section">
      <div class="container">
        <div class="grid cols-2">
          <div class="card">
            <div class="groupTitle"><span class="dot azul"></span><h2 style="margin:0">Grupo AZUL</h2></div>
            <div id="grupoAzul" class="grid" style="margin-top:10px"></div>
          </div>
          <div class="card">
            <div class="groupTitle"><span class="dot rojo"></span><h2 style="margin:0">Grupo ROJO</h2></div>
            <div id="grupoRojo" class="grid" style="margin-top:10px"></div>
          </div>
        </div>
      </div>
    </section>

    <section id="calendario" class="section">
      <div class="container">
        <div class="card">
          <h2>Calendario</h2>
          <p class="muted small">Los partidos se cargan desde <code>results.json</code>. Si no hay fecha, aparecer√° ‚Äú‚Äî‚Äù.</p>
          <table id="tablaCal">
            <thead><tr><th>Jrn</th><th>Fecha</th><th>Fase</th><th>Grupo</th><th>Partido</th><th>Marcador</th><th>Tries</th><th>Estado</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="clasificacion" class="section">
      <div class="container">
        <div class="grid cols-2">
          <div class="card">
            <div class="groupTitle"><span class="dot azul"></span><h2 style="margin:0">Clasificaci√≥n ¬∑ Grupo AZUL</h2></div>
            <div id="tablaAzul" style="margin-top:10px"></div>
          </div>
          <div class="card">
            <div class="groupTitle"><span class="dot rojo"></span><h2 style="margin:0">Clasificaci√≥n ¬∑ Grupo ROJO</h2></div>
            <div id="tablaRojo" style="margin-top:10px"></div>
          </div>
        </div>
        <div class="card" style="margin-top:16px">
          <h2>Cuchara de Madera</h2>
          <p class="muted small">El √∫ltimo clasificado global (sumando grupos) recibe la Cuchara de Madera.</p>
          <div id="cuchara" class="badge bad">por decidir</div>
        </div>
      </div>
    </section>

    <section id="reglamento" class="section">
      <div class="container">
        <div class="card">
          <h2>Reglamento ¬∑ Temporada 60</h2>
          <h3>Formato</h3>
          <ul>
            <li><strong>16 equipos</strong> repartidos en 2 grupos (Azul y Rojo) seg√∫n ranking nacional.</li>
            <li><strong>Jornadas 1‚Äì7:</strong> ida (grupos). <strong>Jornadas 8‚Äì14:</strong> vuelta, invirtiendo local/visitante.</li>
            <li><strong>Jornada 15:</strong> descanso.</li>
            <li><strong>Jornada 16:</strong> finales y cruces por puestos:
              <ul>
                <li><strong>Final:</strong> 1¬∫ Azul vs 1¬∫ Rojo (2 trofeos: campe√≥n y subcampe√≥n).</li>
                <li><strong>3¬∫ puesto:</strong> 2¬∫ Azul vs 2¬∫ Rojo (1 trofeo).</li>
                <li>Resto de equipos: cruces 3¬∫‚Äì8¬∫ por grupo para definir clasificaci√≥n final.</li>
              </ul>
            </li>
          </ul>

          <h3>Sistema de puntuaci√≥n</h3>
          <ul>
            <li>Victoria: <strong>4</strong> puntos ¬∑ Empate: <strong>2</strong> ¬∑ Derrota: <strong>0</strong></li>
            <li>Bonus ofensivo: <strong>+1</strong> por anotar 4 o m√°s tries.</li>
            <li>Bonus defensivo: <strong>+1</strong> por perder por 7 o menos.</li>
          </ul>

          <h3>Clasificaci√≥n fase de grupos</h3>
          <ol>
            <li>Puntos</li>
            <li>Diferencia de puntos (PF ‚àí PC)</li>
            <li>Puntos a favor (PF)</li>
            <li>Resultado directo entre equipos empatados</li>
          </ol>

          <h3>Empate en finales</h3>
          <ol>
            <li>Tries marcados en el partido</li>
            <li>Tries totales en la competici√≥n</li>
          </ol>

          <p class="muted small">Nota: esta web calcula autom√°ticamente puntos, bonus y clasificaci√≥n a partir de <code>results.json</code>.</p>
        </div>
      </div>
    </section>

    <section id="br-terms" class="section">
      <div class="container">
        <div class="card">
          <h2>Blackout Rugby ¬∑ 3rd Party Competition Terms (resumen)</h2>
          <ol class="small">
            <li>La competici√≥n debe tener una web con estructura del torneo y fixtures al d√≠a, y ser transparente para monitorizaci√≥n.</li>
            <li>Debe usar el logo ‚ÄúSanctioned Tournament‚Äù provisto por BR en todas las p√°ginas y enlazar a la home de BR.</li>
            <li>Los recursos de BR no se pueden editar sin permiso escrito.</li>
            <li>Actuar de forma justa y √©tica; la organizaci√≥n puede gestionar incidencias y rechazar participantes si es justo/√©tico.</li>
            <li>Representar positivamente a BR; BR puede solicitar cambios o retirar acceso si lo considera necesario.</li>
            <li>Reportar usos no autorizados de recursos protegidos de BR.</li>
            <li>Garant√≠a de no infringir derechos de terceros e indemnizaci√≥n a Blackout por reclamaciones derivadas.</li>
          </ol>
        </div>
      </div>
    </section>

    <section id="contacto" class="section">
      <div class="container">
        <div class="card">
          <h2>Contacto</h2>
          <p>Organizaci√≥n: <a href="mailto:organizacion@example.com">organizacion@example.com</a> ¬∑ Foro nacional de Blackout Rugby.</p>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">¬© <span id="year"></span> Copa Hisp√°nica ¬∑ T60 ¬∑ <a href="https://www.blackoutrugby.com/home.php" target="_blank" rel="noopener">Blackout Rugby</a></footer>

<script>
const GROUPS = {
  AZUL: [
    {name:"Baskonia", id:"82595"},
    {name:"Chamizos", id:"1558"},
    {name:"Guardo Sharks", id:"40246"},
    {name:"Subterranean Homesick Aliens", id:"79139"},
    {name:"C.R. Guindalera", id:"83261"},
    {name:"U.E Suburense", id:"82879"},
    {name:"Gipuzkoa Errugbi", id:"82824"},
    {name:"Lokomot√≠va Ko≈°ice", id:"6752"},
  ],
  ROJO: [
    {name:"Amics de la Cervesa", id:"83075"},
    {name:"C.P. Les Abelles", id:"82816"},
    {name:"Molledo S.D.", id:"6378"},
    {name:"Chamizos RC", id:"10800"},
    {name:"RIB", id:"82729"},
    {name:"Sparta de Sibaris", id:"82920"},
    {name:"Diogenes Club", id:"350"},
    {name:"Amics de la Pilsner Urquell", id:"74442"},
  ]
};
const STATE = { partidos: [] };
const fmt = (s)=> s? new Date(s.replace(' ','T')+':00').toLocaleString('es-ES',{dateStyle:'medium', timeStyle:'short'}) : '‚Äî';

async function cargarResultados(){
  try{
    const res = await fetch('results.json', {cache:'no-store'});
    if(!res.ok) throw new Error('no results.json');
    const data = await res.json();
    if(Array.isArray(data)) STATE.partidos = data; else throw new Error('formato inv√°lido');
  }catch(e){
    const local = localStorage.getItem('hispanica_results_s60');
    STATE.partidos = local ? JSON.parse(local) : [];
  }
}

function renderGrupos(){
  const azul = document.getElementById('grupoAzul');
  const rojo = document.getElementById('grupoRojo');
  azul.innerHTML = ''; rojo.innerHTML='';
  GROUPS.AZUL.forEach((t,i)=>{
    const d=document.createElement('div'); d.className='note small';
    d.innerHTML = `<strong>${i+1}.</strong> ${t.name} <span class="muted">‚Äî ${t.id}</span>`;
    azul.appendChild(d);
  });
  GROUPS.ROJO.forEach((t,i)=>{
    const d=document.createElement('div'); d.className='note small';
    d.innerHTML = `<strong>${i+1}.</strong> ${t.name} <span class="muted">‚Äî ${t.id}</span>`;
    rojo.appendChild(d);
  });
}

function renderCalendario(){
  const tb = document.querySelector('#tablaCal tbody'); tb.innerHTML='';
  const rows = [...STATE.partidos].sort((a,b)=> (a.jornada??0)-(b.jornada??0) || (a.fase||'').localeCompare(b.fase||''));
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    const marcador = (r.pL!=null && r.pV!=null) ? `${r.pL} ‚Äì ${r.pV}` : '‚Äî';
    const tries = (r.tL!=null && r.tV!=null) ? `${r.tL} ‚Äì ${r.tV}` : '‚Äî';
    const partido = (r.local && r.visitante) ? `${r.local} vs ${r.visitante}` : '‚Äî';
    tr.innerHTML = `<td>${r.jornada??'‚Äî'}</td><td>${fmt(r.fecha)}</td><td>${r.fase||'‚Äî'}</td><td>${r.grupo||'‚Äî'}</td><td>${partido}</td><td>${marcador}</td><td>${tries}</td><td>${r.estado||'pendiente'}</td>`;
    tb.appendChild(tr);
  });
}

function matchPoints(pFor, pAgainst, triesFor){
  // Base points
  let pts = 0;
  if(pFor > pAgainst) pts += 4;
  else if(pFor === pAgainst) pts += 2;
  // Bonuses
  if(typeof triesFor === 'number' && triesFor >= 4) pts += 1;
  if(pFor < pAgainst && (pAgainst - pFor) <= 7) pts += 1;
  return pts;
}

function initTable(teamNames){
  const t = {};
  teamNames.forEach(n=> t[n] = {Equipo:n,PJ:0,PG:0,PE:0,PP:0,PF:0,PC:0,Diff:0,TB:0,Pts:0,PB_ens:0,PB_der:0,Tries:0});
  return t;
}

function computeGroup(groupKey){
  const teamNames = GROUPS[groupKey].map(x=>x.name);
  const tab = initTable(teamNames);

  const played = STATE.partidos.filter(p=> (p.grupo===groupKey) && (p.estado==='finalizado') && (p.pL!=null) && (p.pV!=null));
  played.forEach(p=>{
    const L = tab[p.local]; const V = tab[p.visitante];
    if(!L || !V) return;
    L.PJ++; V.PJ++;
    L.PF += p.pL; L.PC += p.pV; V.PF += p.pV; V.PC += p.pL;
    L.Tries += (typeof p.tL==='number' ? p.tL : 0);
    V.Tries += (typeof p.tV==='number' ? p.tV : 0);

    if(p.pL>p.pV){ L.PG++; V.PP++; }
    else if(p.pL<p.pV){ V.PG++; L.PP++; }
    else { L.PE++; V.PE++; }

    // bonus counters
    if(typeof p.tL==='number' && p.tL>=4) L.PB_ens++;
    if(typeof p.tV==='number' && p.tV>=4) V.PB_ens++;
    if(p.pL<p.pV && (p.pV-p.pL)<=7) L.PB_der++;
    if(p.pV<p.pL && (p.pL-p.pV)<=7) V.PB_der++;

    L.Pts += matchPoints(p.pL,p.pV,p.tL);
    V.Pts += matchPoints(p.pV,p.pL,p.tV);
  });
  Object.values(tab).forEach(r=> r.Diff = r.PF - r.PC);

  // Head-to-head helper (only used when exactly two teams are tied on Pts, Diff, PF)
  function headToHead(a,b){
    const h2h = played.filter(p=> (p.local===a && p.visitante===b) || (p.local===b && p.visitante===a));
    if(h2h.length===0) return 0;
    let ptsA = 0, ptsB = 0, diffA = 0;
    h2h.forEach(p=>{
      if(p.local===a){
        ptsA += matchPoints(p.pL,p.pV,p.tL);
        ptsB += matchPoints(p.pV,p.pL,p.tV);
        diffA += (p.pL - p.pV);
      }else{
        ptsA += matchPoints(p.pV,p.pL,p.tV);
        ptsB += matchPoints(p.pL,p.pV,p.tL);
        diffA += (p.pV - p.pL);
      }
    });
    if(ptsA !== ptsB) return ptsA - ptsB;
    return diffA; // fallback
  }

  const arr = Object.values(tab).sort((x,y)=>{
    if(y.Pts!==x.Pts) return y.Pts-x.Pts;
    if(y.Diff!==x.Diff) return y.Diff-x.Diff;
    if(y.PF!==x.PF) return y.PF-x.PF;
    // direct result (only if they are the two tied)
    return headToHead(x.Equipo,y.Equipo) * -1; // because sort expects y before x
  });
  return arr;
}

function renderTable(targetId, rows){
  const el = document.getElementById(targetId);
  const tbl = document.createElement('table');
  tbl.innerHTML = `<thead><tr>
    <th>Pos</th><th>Equipo</th><th>PJ</th><th>PG</th><th>PE</th><th>PP</th>
    <th>PF</th><th>PC</th><th>Diff</th><th>PB ens.</th><th>PB der.</th><th>Pts</th>
  </tr></thead>`;
  const tb = document.createElement('tbody');
  rows.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${r.Equipo}</td><td>${r.PJ}</td><td>${r.PG}</td><td>${r.PE}</td><td>${r.PP}</td>
      <td>${r.PF}</td><td>${r.PC}</td><td>${r.Diff}</td><td>${r.PB_ens}</td><td>${r.PB_der}</td><td><strong>${r.Pts}</strong></td>`;
    tb.appendChild(tr);
  });
  tbl.appendChild(tb);
  el.innerHTML='';
  el.appendChild(tbl);
}

function renderCuchara(azul, rojo){
  const all = [...azul, ...rojo];
  if(all.length===0){ document.getElementById('cuchara').textContent='por decidir'; return; }
  // last by points then diff then PF
  const sorted = [...all].sort((a,b)=> a.Pts-b.Pts || a.Diff-b.Diff || a.PF-b.PF);
  const last = sorted[0];
  document.getElementById('cuchara').textContent = last.Equipo;
}

function renderProximoYUltimos(){
  const futuros = STATE.partidos.filter(p=> p.estado!=='finalizado' && p.local && p.visitante);
  const conFecha = futuros.filter(p=> p.fecha).map(p=> ({...p,cuando:new Date(p.fecha.replace(' ','T'))})).sort((a,b)=> a.cuando-b.cuando);
  const prox = conFecha[0] || futuros.sort((a,b)=> (a.jornada??0)-(b.jornada??0))[0];
  const div = document.getElementById('proximo');
  if(prox){ div.innerHTML = `<strong>${prox.local}</strong> vs <strong>${prox.visitante}</strong><br><span class="muted">${prox.fase} ¬∑ ${prox.grupo||''} ¬∑ ${prox.fecha?fmt(prox.fecha):'Fecha por confirmar'}</span>`; }
  else div.textContent='No hay partidos pendientes';

  const jugados = STATE.partidos.filter(p=> p.estado==='finalizado' && p.pL!=null && p.pV!=null)
    .sort((a,b)=> (b.jornada??0)-(a.jornada??0));
  const ul=document.getElementById('ultimos'); ul.innerHTML='';
  if(jugados.length===0){ ul.innerHTML='<li>Todav√≠a no hay resultados.</li>'; return; }
  jugados.slice(0,6).forEach(p=>{
    const li=document.createElement('li');
    li.textContent = `${p.local} ${p.pL}-${p.pV} ${p.visitante} ¬∑ ${p.fase} ¬∑ ${p.grupo||''}`;
    ul.appendChild(li);
  });
}

function bindAdmin(){
  const toggle=document.getElementById('adminToggle');
  const panel=document.getElementById('adminPanel');
  toggle.addEventListener('change',()=> panel.style.display = toggle.checked ? 'block':'none');

  document.getElementById('btnExport').addEventListener('click',()=>{
    const blob=new Blob([JSON.stringify(STATE.partidos,null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='results.json'; a.click(); URL.revokeObjectURL(a.href);
  });
  document.getElementById('btnLoadRepo').addEventListener('click',async()=>{
    await cargarResultados();
    document.getElementById('jsonArea').value = JSON.stringify(STATE.partidos,null,2);
    renderAll();
  });
  document.getElementById('btnImport').addEventListener('click',()=>{
    try{
      const data=JSON.parse(document.getElementById('jsonArea').value);
      if(Array.isArray(data)){ STATE.partidos=data; renderAll(); alert('Datos importados'); }
      else alert('El JSON debe ser un array');
    }catch(e){ alert('JSON inv√°lido'); }
  });
  document.getElementById('btnGuardarLocal').addEventListener('click',()=>{
    localStorage.setItem('hispanica_results_s60', JSON.stringify(STATE.partidos));
    alert('Guardado en este navegador. Sube el results.json al repo para hacerlo p√∫blico.');
  });
  document.getElementById('btnReset').addEventListener('click',()=>{
    // reset to template shipped in repo
    location.reload();
  });
}

function renderAll(){
  renderGrupos();
  renderCalendario();
  const azul = computeGroup('AZUL');
  const rojo = computeGroup('ROJO');
  renderTable('tablaAzul', azul);
  renderTable('tablaRojo', rojo);
  renderCuchara(azul, rojo);
  renderProximoYUltimos();
}

(async function(){
  document.getElementById('year').textContent = new Date().getFullYear();
  await cargarResultados();
  bindAdmin();
  renderAll();
})();
</script>
</body>
</html>
